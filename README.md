# AH4 software development kit

*for developing, research & fun*

---
![](./Core/cover.jpg)

---
- [AH4 hardware repository](https://github.com/Barsy-Barsevich/Barsotion-AH4)

## Установка
Потребуется командная строка `bash`. Если у вас не Linux, это плохо. Можете исправить положение установкой WSL или применить GitBash.
```
git clone git@github.com:Barsy-Barsevich/AH4-SDK.git --recursive
cd AH4-SDK
make build-sdk
```

## Структура проекта
- `components` (дополнительные библиотеки);
- `core` (системные библиотеки и драйвера);
- `examples` (примеры);
- `wch-isp` (прошивальщик);
- `config.txt` (файл с настройсками сборки);
- `Makefile`.

## Конфигурация сборки
По-умолчанию конфигурация такова.
```
TOOLCHAIN_PREFIX = riscv64-unknown-elf
OPTIMIZATION_LEVEL = O2
ARCH = rv32imafc
ABI = ilp32f
CODE_MODEL = medlow
```
Итак, что есть что:
- `TOOLCHAIN_PREFIX` - это префикс или путь riscv-тулчейна. 
- `OPTIMIZATION_LEVEL` - это ключ оптимизации, который будет применяться при сборке проектов и библиотек по-умолчанию. Ключ оптимизации можно переопределять при сборке.
- `ARCH` - целевая система команд. Для микроконтроллеров, установленных в AH4 и PL1, система команд - `rv32imafc`.
- `ABI` - соглашение о вызовах. Это еще одна настройка целевой платформы. Для набора команд `rv32imafc` имеет смысл использовать `ilp32f`.
- `CODE_MODEL` - модель генерации кода RISC-V. На эту тему можно почитать спеки RISC-V. Всего есть два значения, `medlow` и `medany`.

Варианты оптимизации:
- `O0` - без оптимизации;
- `O1` - несильная оптимизация (выкинуть неиспользуемые функции и т.д.);
- `O2` - оптимизация по времени выполнения;
- `O3` - "агресивная" оптимизация по времени выполнения;
- `Os` - оптимизация по количеству памяти программ;
- `Oz` - "агресивная" оптимизация по количеству памяти программ;
- `Og` - оптимизация для более удобной отладки.

## Работа с SDK
Для начала необходимо собрать библиотеки и компоненты:
```
make build-libs
```
Если хотим пересобрать проект, применяем следующую команду. Эта команда удаляет все собранные файлы всех системных библиотек и компонентов.
```
make clean-libs
```

Сборка проекта:
```
make build-project target=<path-to-your-project>
```
Если хотим переопределить ключи оптимизации:
```
make build-project target=<path-to-your-project> OPTIMIZATION_LEVEL=Os
```
После сборки проекта в его директории окажется `.hex` файл с прошивкой.

Для удаления всех собранных файлов проекта:
```
make clean-project target=<path-to-your-project>
```

### Прошивка микроконтроллера
```
make upload firmware=<path-to-hex-file>
```